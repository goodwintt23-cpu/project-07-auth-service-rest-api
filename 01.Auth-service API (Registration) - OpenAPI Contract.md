# Auth-service API (Registration) - OpenAPI Contract

## 0. Назначение

Документ фиксирует контракт блока "Регистрация" в auth-service:

- POST `/auth/register`
- POST `/auth/verify`
- POST `/auth/request_verification_code/`

## 1. Источник истины

- Ошибки, коды и единый формат ошибки - в документе "Ошибки и коды ответов API (auth-service)".  
- Фиксируется структура ErrorResponse (error_code + details[]), включая служебные поля trace_id и date.

## 2. Общая информация об API


```yaml
openapi: 3.1.0
info:
  title: auth_service
  description: Auth service
  version: 0.0.1
```


---

## 3. Общие правила: формат ошибки (ErrorResponse)

Единый формат ошибки - один для всех эндпоинтов.

### 3.1. OpenAPI схема ошибки (фрагмент)

```yaml
components:
  schemas:
    ErrorDetail:
      type: object
      required: [message, type]
      properties:
        field:
          type: string
          nullable: true
          description: Поле, к которому относится ошибка (или null)
        message:
          type: string
          description: Человекочитаемое сообщение
        type:
          type: string
          description: Машинный тип детали
        trace_id:
          type: string
          format: uuid
          nullable: true
          description: Идентификатор трассировки (uuid или null)
        date:
          type: string
          format: date-time
          nullable: true
          description: Дата и время по UTC (ISO-8601)

    ErrorResponse:
      type: object
      required: [error_code, details]
      properties:
        error_code:
          type: string
          description: Машинный код ошибки верхнего уровня
        details:
          type: array
          items:
            $ref: "#/components/schemas/ErrorDetail"
```

### 3.2. Пример payload ошибки (как реально отвечает API)

```json
{
  "error_code": "REGISTER_INVALID_PASSWORD",
  "details": [
    {
      "field": "password",
      "message": "Пароль не соответствует политике.",
      "type": "register_invalid_password",
      "trace_id": "00000000-0000-0000-0000-000000000000",
      "date": "YYYY-MM-DDTHH:mm:ssZ"
    }
  ]
}
```

### 3.3. HTTP-коды

Используемые HTTP-коды фиксированы в документе "Ошибки и коды ответов API (auth-service) (в т.ч. `200`/`201`/`403`/`404`/`409`/`422`/`429`/`500`).  
Для `429` сервис возвращает header `Retry-After` (секунды).

---

## 4. Модели данных (schemas)

### 4.1. RegisterRequest

```yaml
    RegisterRequest:
      type: object
      required: [email, password, consent_ppd, offer_agreement]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
        consent_ppd:
          type: boolean
        offer_agreement:
          type: boolean
```

### 4.2. RegisterResponse

```yaml
    RegisterResponse:
      type: object
      required:
        - id
        - email
        - is_active
        - is_superuser
        - is_verified
        - created_at
        - updated_at
        - consent_ppd
        - offer_agreement
        - user_url
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        is_active:
          type: boolean
        is_superuser:
          type: boolean
        is_verified:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        consent_ppd:
          type: boolean
        offer_agreement:
          type: boolean
        user_url:
          type: string
          description: Публичный идентификатор пользователя (public id)
```

### 4.3. VerifyRequest / VerifyResponse

```yaml
    VerifyRequest:
      type: object
      required: [email, verification_code]
      properties:
        email:
          type: string
          format: email
        verification_code:
          type: string
```

```yaml
    VerifyResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
```
### 4.4. ResendVerificationCodeRequest / Response

```yaml
    ResendVerificationCodeRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email

    ResendVerificationCodeResponse:
      type: object
      required: [message]
      properties:
        message:
          type: string
```

---

## 5. Эндпоинты API (paths)

### 5.1. POST `/auth/register`

Назначение: создать аккаунт.

```yaml
paths:
  /auth/register:
    post:
      summary: Регистрация (создание аккаунта)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Пользователь создан
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"
        "409":
          description: Конфликт (пользователь уже существует)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Ошибка валидации (email/password/consents)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Внутренняя ошибка (error_code=INTERNAL_ERROR)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
```

---

### 5.2. POST `/auth/verify`

Назначение: подтвердить аккаунт по email и коду (verification_code).

```yaml
paths:
  /auth/verify:
    post:
      summary: Подтверждение аккаунта
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyRequest"
      responses:
        "200":
          description: Подтвержден успешно
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyResponse"
        "403":
          description: Доступ запрещен (аккаунт заблокирован)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Пользователь не найден
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Конфликт состояния (уже подтвержден)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Ошибка валидации (код неверный/истек)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Превышены лимиты
          headers:
            Retry-After:
              schema:
                type: integer
              description: Сколько секунд ждать до следующей попытки
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Внутренняя ошибка (error_code=INTERNAL_ERROR)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
```

---

### 5.3. POST `/auth/request_verification_code/`

Назначение: повторно отправить код подтверждения.

```yaml
paths:
  /auth/request_verification_code/:
    post:
      summary: Повторная отправка кода подтверждения
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResendVerificationCodeRequest"
      responses:
        "200":
          description: Код отправлен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResendVerificationCodeResponse"
        "403":
          description: Аккаунт заблокирован
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Пользователь не найден
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Пользователь уже подтвержден
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Ошибка валидации email
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Cooldown не истек
          headers:
            Retry-After:
              schema:
                type: integer
              description: Сколько секунд ждать до следующей попытки
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Внутренняя ошибка (error_code=INTERNAL_ERROR)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
```

---

## 6. Связанные документы

- Endpoints page (как пользоваться, примеры): `Auth-service API (Registration) - Endpoints.md`
- Ошибки и коды ответов: `Ошибки и коды ответов API (auth-service).md`

---

## 7. Принятые решения

- Verify: `POST /auth/verify` + body `{email, verification_code}`
- Success 201 `/auth/register`: возвращаем `RegisterResponse` (см. schema)
- Единый формат ошибок: `ErrorResponse` (error_code + details[])
- Поля `trace_id` и `date` в `ErrorDetail` не являются обязательными (могут отсутствовать/быть null), но рекомендуются к заполнению для трассировки и аудита.
