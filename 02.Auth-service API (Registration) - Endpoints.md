# Auth-service API (Registration) - Endpoints

## 0. Назначение

Документ фиксирует эндпоинты блока "Регистрация" в auth-service:

- POST `/auth/register`
- POST `/auth/verify`
- POST `/auth/request_verification_code/`

- Для каждого эндпоинта указан: назначение, request, пример запроса, success response, ошибки.
- Ошибки (4xx/5xx) возвращаются в едином формате `ErrorResponse`.
- Семантика кодов ошибок и HTTP-статусов считается источником истины по документу "Ошибки и коды ответов API (auth-service)".

Единый формат ошибки (для всех 4xx/5xx):

```json
{
  "error_code": "STRING_CODE",
  "details": [
    {
      "field": "field_name_or_null",
      "message": "Человекочитаемое сообщение об ошибке",
      "type": "string_type_code",
      "trace_id": "00000000-0000-0000-0000-000000000000",
      "date": "YYYY-MM-DDTHH:mm:ssZ"
    }
  ]
}
```

Пояснения:

- `error_code` - машинный код ошибки верхнего уровня (UPPER_SNAKE_CASE).
- `details` - массив деталей ошибки.
- `details[].field` - имя поля (например `email`, `password`) или `null`, если ошибка общая.
- `details[].message` - человекочитаемое описание.
- `details[].type` - машинный тип детали (lower_snake_case).
- `details[].trace_id` - UUID трассировки (генерируется backend); `uuid` или `null` (если есть).
- `details[].date` - UTC timestamp в ISO-8601 (если есть).
- Поля `trace_id` и `date` в `details[]` могут отсутствовать/быть `null`; рекомендуются для трассировки и аудита.

Дополнительно для `429`:

- Сервис возвращает header `Retry-After` (в секундах).

---

## 1. POST `/auth/register` - регистрация (создание аккаунта)

### Назначение

Создает учетную запись пользователя.

#### Request body

```json
{
  "email": "user@example.com",
  "password": "<example_password>",
  "consent_ppd": true,
  "offer_agreement": true
}
```

**Пример запроса**

```bash
curl -X POST {{baseUrl}}/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"<example_password>","consent_ppd":true,"offer_agreement":true}'
```

#### Response 201

```json
{
  "id": "00000000-0000-0000-0000-000000000000",
  "email": "user@example.com",
  "is_active": true,
  "is_superuser": false,
  "is_verified": false,
  "created_at": "YYYY-MM-DDTHH:mm:ssZ",
  "updated_at": "YYYY-MM-DDTHH:mm:ssZ",
  "consent_ppd": true,
  "offer_agreement": true,
  "user_url": "<public_id>"
}
```

Пояснения:

- `id` - UUID пользователя.
- `email` - email пользователя.
- `is_active` - признак активного аккаунта.
- `is_superuser` - признак административных прав.
- `is_verified` - признак подтвержденного аккаунта.
- `created_at`, `updated_at` - UTC timestamp в ISO-8601.
- `consent_ppd` - согласие на обработку персональных данных.
- `offer_agreement` - принятие оферты/условий.
- `user_url` - публичный идентификатор пользователя (public id).

**Ошибки**

|  HTTP | Когда                              | error_code                                      | field                         |
| ----: | ---------------------------------- | ----------------------------------------------- | ----------------------------- |
| `422` | email пустой                       | EMAIL_IS_EMPTY                                  | email                         |
| `422` | email невалидный                   | INVALID_EMAIL / INVALID_EMAIL_FORMAT            | email                         |
| `422` | пароль пустой/не проходит политику | REGISTER_INVALID_PASSWORD                       | password                      |
| `422` | не приняты согласия                | CONSENT_PPD_REQUIRED / OFFER_AGREEMENT_REQUIRED | consent_ppd / offer_agreement |
| `409` | пользователь уже существует        | REGISTER_USER_ALREADY_EXISTS                    | email                         |
| `500` | внутренняя ошибка                  | INTERNAL_ERROR                                  | null                          |

---

## 2) POST `/auth/verify` - подтверждение аккаунта

### Назначение

Подтверждает аккаунт по email и коду подтверждения.

#### Request body

```json
{
  "email": "user@example.com",
  "verification_code": "123456"
}
```

**Пример запроса**

```bash
curl -X POST {{baseUrl}}/auth/verify \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","verification_code":"123456"}'
```

#### Response 200 (пример)

```json
{
  "message": "Пользователь подтвержден."
}
```

**Ошибки**

|  HTTP | Когда                        | error_code                | field             |
| ----: | ---------------------------- | ------------------------- | ----------------- |
| `404` | пользователь не найден       | USER_NOT_FOUND            | null              |
| `409` | уже подтвержден              | USER_IS_ALREADY_VERIFIED  | null              |
| `403` | аккаунт заблокирован         | USER_BLOCKED              | null              |
| `422` | неверный код                 | VERIFICATION_CODE_INVALID | verification_code |
| `422` | код истек                    | TOKEN_IS_OLD              | verification_code |
| `429` | лимит попыток/частые запросы | TOO_MANY_REQUESTS         | null              |
| `500` | внутренняя ошибка            | INTERNAL_ERROR            | null              |

---

## 3) POST `/auth/request_verification_code/` - повторная отправка кода

### Назначение

Повторно отправляет код подтверждения на email.

#### Request body

```json
{
  "email": "user@example.com"
}
```

**Пример запроса****

```bash
curl -X POST {{baseUrl}}/auth/request_verification_code/ \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com"}'
```

#### Response 200 (пример)

```json
{
  "message": "Код отправлен."
}
```

**Ошибки**

|  HTTP | Когда                           | error_code                           | field |
| ----: | ------------------------------- | ------------------------------------ | ----- |
| `422` | email пустой                    | EMAIL_IS_EMPTY                       | email |
| `422` | email невалидный                | INVALID_EMAIL / INVALID_EMAIL_FORMAT | email |
| `404` | пользователь не найден          | USER_NOT_FOUND                       | null  |
| `409` | пользователь уже подтвержден    | USER_IS_ALREADY_VERIFIED             | null  |
| `403` | аккаунт заблокирован            | USER_BLOCKED                         | null  |
| `429` | cooldown не истек (Retry-After) | TOO_MANY_REQUESTS                    | null  |
| `500` | внутренняя ошибка               | INTERNAL_ERROR                       | null  |
