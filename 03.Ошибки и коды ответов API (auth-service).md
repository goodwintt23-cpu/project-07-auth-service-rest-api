# Ошибки и коды ответов API (auth-service)

## 0. Описание:
Артефакт, который задает и актуализирует единый контракт ошибок (status-коды + формат тела ответа) для auth-service в области “Регистрация + Аутентификация”. Используется как источник договоренностей для реализации и приемки.

Основание: 
- Auth-service API (Registration) - OpenAPI Contract
- Auth-service API (Registration) - Endpoints
## 1. Общий формат ответа об ошибке

Все ошибки сервиса возвращаются в едином формате (включая ошибки валидации FastAPI/Pydantic - их маппим в этот формат).

```json
{
  "error_code": "STRING_CODE",
  "details": [
    {
      "field": "optional_field_or_null",
      "message": "Человекочитаемое сообщение",
      "type": "string_type",
      "trace_id": "optional_uuid_or_null",
      "date": "optional_utc_datetime"
    }
  ]
}
```

Пояснения:

- `error_code` - машинный код ошибки верхнего уровня (UPPER_SNAKE_CASE)
- `details[]` - массив деталей ошибки.
- `details[].field` - имя поля (например `email`, `password`) или `null`, если ошибка общая.
- `details[].message` - человекочитаемое сообщение.
- `details[].type` - машинный тип детали (lower_snake_case).
- `details[].trace_id` - UUID трассировки (генерируется backend); `uuid` или `null` (если есть).
- `details[].date` - UTC timestamp в ISO-8601 (если есть).
- Поля `trace_id` и `date` в `details[]` могут отсутствовать/быть `null`.
## 2. Используемые HTTP-коды

|   Код | Название              | Использование                                                                                          |
| ----: | --------------------- | ------------------------------------------------------------------------------------------------------ |
| `200` | OK                    | Успех (verify, resend, login/logout и др.)                                                             |
| `201` | Created               | Успех (register создал пользователя)                                                                   |
| `401` | Unauthorized          | Ошибка входа (неверные учетные данные)                                                                 |
| `403` | Forbidden             | Доступ запрещен (аккаунт заблокирован)                                                                 |
| `404` | Not Found             | Ресурс/пользователь не найден                                                                          |
| `409` | Conflict              | Конфликт состояния/ресурса (например, email занят; пользователь уже подтвержден)                       |
| `422` | Unprocessable Entity  | Ошибка валидации/проверки входных данных (включая “пусто”, формат, политика пароля, чекбоксы согласий) |
| `429` | Too Many Requests     | Превышены лимиты / не истек cooldown                                                                   |
| `500` | Internal Server Error | Внутренняя ошибка                                                                                      |

Дополнительно для `429`:

- Сервис возвращает header `Retry-After` (в секундах).

## 3. Общие правила возврата ошибок

1. Пустое значение трактуем одинаково: поле отсутствует / `null` / `""` / только пробелы - это “пусто”.
2. Все ошибки валидации (включая те, что раньше уходили как `HTTPValidationError`) возвращаем как `422` и приводим к единому формату.
3. Конфликты состояния/ресурса - `409` (пример: email уже занят; пользователь уже подтвержден).
4. Блокировка/запрет доступа - `403` (пример: пользователь заблокирован).
5. Лимиты:
	- для resend действует cooldown, `429` + `Retry-After`.
6. Чекбоксы согласий `offer_agreement` и `consent_ppd` - часть запроса регистрации и валидируются на BE. При отсутствии/false - `422`.

## 4. Матрица ошибок по эндпоинтам

### 4.1. `POST /auth/register`

Назначение: создание аккаунта.

Коды:

|  HTTP | error_code                   | Когда возникает                          | field           | Примечание для UI/QA        |
| ----: | ---------------------------- | ---------------------------------------- | --------------- | --------------------------- |
| `201` | -                            | Пользователь создан                      | -               | Переход на экран ввода кода |
| `422` | EMAIL_IS_EMPTY               | email пустой (включая "", null, пробелы) | email           | Подсветить email            |
| `422` | INVALID_EMAIL                | недопустимые символы                     | email           | Подсветить email            |
| `422` | INVALID_EMAIL_FORMAT         | неверный формат                          | email           | Подсветить email            |
| `422` | REGISTER_INVALID_PASSWORD    | password пустой/не проходит политику     | password        | Подсветить password         |
| `422` | CONSENT_PPD_REQUIRED         | consent_ppd отсутствует/false            | consent_ppd     | Подсветить чекбокс          |
| `422` | OFFER_AGREEMENT_REQUIRED     | offer_agreement отсутствует/false        | offer_agreement | Подсветить чекбокс          |
| `409` | REGISTER_USER_ALREADY_EXISTS | email уже зарегистрирован                | email           | Показать “email уже занят”  |
| `500` | INTERNAL_ERROR               | внутренняя ошибка                        | null            | Общая ошибка                |

Пример ошибки `422`:

```json
{
  "error_code": "REGISTER_INVALID_PASSWORD",
  "details": [
    {
      "field": "password",
      "message": "Пароль не соответствует политике.",
      "type": "register_invalid_password",
      "trace_id": "uuid-or-null",
      "date": "utc-datetime-or-null"
    }
  ]
}
```

- **Правило маппинга:**
	- Ошибки валидации (например пароль) возвращаем как `422`.
	- Конфликт ресурса (email уже существует) возвращаем как `409`.

### 4.2. `POST /auth/verify`

Назначение: подтверждение аккаунта по `email` и `verification_code`

Коды:

|  HTTP | error_code                | Когда возникает                                   | field             | Примечание для UI/QA                       |
| ----: | ------------------------- | ------------------------------------------------- | ----------------- | ------------------------------------------ |
| `200` | -                         | Подтвержден успешно                               | -                 | Переход на авторизацию (или следующий шаг) |
| `422` | VERIFICATION_CODE_INVALID | verification_code пустой/неверный формат          | verification_code | Подсветить поле кода                       |
| `422` | TOKEN_IS_OLD              | код подтверждения истек (TTL кода истек)          | verification_code | Показать “код истек”, предложить resend    |
| `404` | USER_NOT_FOUND            | email не найден                                   | null              | Общая ошибка                               |
| `409` | USER_IS_ALREADY_VERIFIED  | уже подтвержден                                   | null              | Сообщение “уже подтвержден”                |
| `403` | USER_BLOCKED              | аккаунт заблокирован                              | null              | Сообщение + запрет                         |
| `429` | TOO_MANY_REQUESTS         | превышены попытки/лимит (при наличии ограничения) | null              | Блок/таймер                                |
| `500` | INTERNAL_ERROR            | внутренняя ошибка                                 | null              | Общая ошибка                               |

Примечания:

- Правило: в БД хранится timestamp создания кода; если TTL кода истек - возвращаем TOKEN_IS_OLD.
- **Правило маппинга:**
	- Ошибки ввода кода подтверждения объединяем в `422` `VERIFICATION_CODE_INVALID`.
	- Истечение срока кода выделяем в `422` `TOKEN_IS_OLD`.
- `429` применяется при превышении лимита попыток подтверждения.;


Пример успеха `200`:

```json
{
  "message": "Пользователь подтвержден."
}
```

### 4.3. `POST /auth/request_verification_code/`

Назначение: повторная отправка проверочного кода на email.

Коды:

|  HTTP | error_code                           | Когда возникает                | field | Примечание для UI/QA     |
| ----: | ------------------------------------ | ------------------------------ | ----- | ------------------------ |
| `200` | -                                    | Код отправлен                  | -     | Показать таймер cooldown |
| `422` | EMAIL_IS_EMPTY                       | email пустой                   | email | Подсветить email         |
| `422` | INVALID_EMAIL / INVALID_EMAIL_FORMAT | email невалидный               | email | Подсветить email         |
| `404` | USER_NOT_FOUND                       | пользователь не найден         | null  | Общая ошибка             |
| `409` | USER_IS_ALREADY_VERIFIED             | уже подтвержден                | null  | Сообщение                |
| `403` | USER_BLOCKED                         | заблокирован                   | null  | Сообщение                |
| `429` | TOO_MANY_REQUESTS                    | cooldown не истек              | null  | Блокировка кнопки resend |
| `500` | INTERNAL_ERROR                       | ошибка генерации/отправки кода | null  | Общая ошибка             |

Примечания:

Правило cooldown:
- cooldown - задается настройкой (configurable).
- при `429` возвращаем `Retry-After` (секунды) согласно настройке.
**Правило маппинга:**
- “Превышение лимитов/cooldown возвращаем как `429` `TOO_MANY_REQUESTS` (+ `Retry-After`).”
